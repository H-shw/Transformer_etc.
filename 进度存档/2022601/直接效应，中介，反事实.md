# 直接效应，中介，反事实

[toc]





##### 回归系数 与 路径系数
$$
E[Y|X_{1} = x_{1},X_{2} = x_{2}....,X_{n} = x_{n}]=r_{0} +r_{1}x_{1} + r_{2}x_{2} +...+ r_{n}x_{n}
$$



其中$r_1$ , $r_2$ ,..., $r_{n}$ 被称为回归系数(或者相关系数)。

回归系数是表示变量之间的统计特征，也就是我们站在因果关系之梯第一层级用观测数据归纳出
的，它只是对客观事实的描述，$y= r_{1}x十r_{2}y$ 不能说明$X$和$Z$是$Y$的因。

与回归系数不同，路径系数则反映的是变量之间的因果关系或者结构关系，是因果关系之梯第二层级的信息。比如我们定义 $Y=3X+U $ 这就说明 $X$ 和 $Y$ 之间有因果关系路径 $X→Y$ , 且路径系数为 $3$。**每一个路径系数都表示一条因果关系。**

考虑下图中的图模型。其中$a,b, c, d, e$分别标出了五条因果关系路径的路径系数。

事实上，这样，我们就将图的三个要素都凑齐了。(节点代表变量，边代表因果关系，权重代表路径系数，可以代表一条因果关系的决定程度？)



![1.11.png](https://github.com/H-shw/Transformer_etc./blob/master/notes/casual%20inference/pics/1.11.png?raw=true)

假设我们想要计算$Z$对$Y$的因果效应的总和。那么计算的方式就是将每一条因果路径上的因果
系数与对应变量相乘,然后对所有非后门路径求和。
$$
\begin{align*}
Y&=dZ+eW + U_{y}\\
&=dZ+e(bX+cZ)+U_{Y}+eU_{w}\\
&=(d+ec)Z+ebX+U_{Y}+eU_{w}
\end{align*}
$$


##### 计算两个变量之间的直接效应

![1.12.png](https://github.com/H-shw/Transformer_etc./blob/master/notes/casual%20inference/pics/1.12.png?raw=true)

比如计算 $X$ 与 $Y$ 的直接效应 $\alpha$ 。

方法如下:

1.移除$X$与$Y$之间的箭头(如果没有直接相连的箭头,那就说明 $a=0$ )。

2.得到的新图称为 $G_a$，如果 $G_a$ 中有一组变量 $Z$ 能够将 $X$ 和  $Y$ d分离 ,那么我们就可以求出 $Y$ 关于 $X$ 和 $Z$ 的回归模型。

如图2 (左)的有向无环图，我们去掉 X $\rightarrow$ Y 的箭头，得到右边的有向无环图,在右图中,W作为中间节点d分离了X和Y。因此我们建立Y关于X和W的回归模型:

$Y=r_{x}X+r_{w}W十∈$

其中 $r_x$ 就是 $X$ 对 $Y$ 的直接因果效应。然后我们只要观测出回归模型中这些变量的值就可以估计出参数的值了。



##### 工具变量

去掉箭头以后，没有变量能将 $X$ 和 $Y$ d分离，**且X到Y之间存在一个无法观察的变量(可能是混杂因子，是否相当于把Z视作上文不需要工具变量的X？)**, 可以引入工具变量

![1.13.png](https://github.com/H-shw/Transformer_etc./blob/master/notes/casual%20inference/pics/1.13.png?raw=true)

$X$ 和 $Y$ 之间只有一条路径 $a$，还有一个未观测的共因(虚线表示)。
此时，去掉$X$和$Y$之间的箭头后，无法找到能够$d$分离$X$和$Y$的变量(集)了。

此时应当找一个工具变量 $Z$ 来求出 $\alpha$.

如果一个变量在新的图 $G_a$ 中与 $Y$ 是d分离，但是与 $X$ 是d相连的，那么这个变量就可以被作为工具变量。

建立 $Y$ 关于 $Z、X$ 关于 $Z$ 的回归关系：$y=r_{1}z \, +∈、x=r_{2}z \,+∈$。
$$
β= r_2\\
aβ= r_1\\
\alpha = r_{1}/r_{2}
$$

##### 中介

![1.14.png](https://github.com/H-shw/Transformer_etc./blob/master/notes/casual%20inference/pics/1.14.png?raw=true)

上图中，我们认为 学历 $Z$ 是一个中介。

**要注意这与后门路径的不同，后门准则使用的场景是叉式的共因，中介是链式的，计算直接影响。**

首先，性别直接影响录取结果 ， 其次,性别通过学历这个中介变量来间接影响录取结果。

为了找到性别对录取结果的直接效应，我们需要以某种方式消除中介变量(此时就是混杂因子)的影
响，也即保持学历不变,然后衡量性别与录取结果之间的关系: 由于学历不变 , 录取结果上的任何变化都只能由性别决定。这是通过**以中介变量为条件**来实现的。

而对于右图，以中介变量为条件不能获得性别与录取结果直接的关系，因此应当干预 $Z$ ,切断 $X$ 或 $I$ 经由 $Z$ 的间接路径或后门路径。

**受控直接效应**（Controlled Directed Effect, CDE）

其计算方式为:
$$
\begin{align*}
CDE&= P(Y = y|do(X= x),do(Z= z))- P(Y = y|do(X = x), do(Z = z))\\
&//使用法则2,\,P(y|do(x),do(z),w)=P(y|do(x),z,w)\,\,\,if(Y与Z无关|X,W)_{G_{\overline X \underline Z}}\\
&= P(Y =y|X=x,do(Z=z))- P(Y =y|X= x',do(Z= z))\\
&//后门准则的应用\\
&= \sum_{i}[P(Y=y|X=x,Z=z,I=i) - P(Y =y|X =x',Z=z,I = i)]P(I =i)
\end{align*}
$$
当以下两个条件都满足时,以Z为中介变量，可以计算出变量$X$对变量$Y$的**CDE**:

1.存在一组变量集 $S_1$ 能够阻断 $Z \rightarrow Y$ 的所有后门路径 (去除**中介**的影响)。

2.当去掉指向 $Z$ 的所有箭头后，存在 变量集 $S_2$ 能够阻断 $X \rightarrow Y$ 的所有后门路径(去除**后门路径**的影响)。

##### 反事实（Counterfactual）

通过未发生的条件来推理可能的结果，就是反事实推理的问题。

我们用$M$表示结构因果模型，$F$ 表示 $M$ 中的函数集，$V$ 是 $M$ 中的变量集。$U=u$ 表示对某个外生变量的赋值。

**反事实的表述: $Y_{x}(u)=y$, 表示" 在 $U=u$ 的情形下，假如 $X=x$  , 则 $Y=y$ 。**

假如 $X=x$ 可以看作外部的干预，$do(X=x)$ 

假设一个结构因果模型M定义如下:
$$
X=aU\\
Y= bX+ U
$$
那么计算反事实 $Y_{x}(u)$ 就意味着在求$U= u$时,如果我们强制让$X =x$，$Y$应该等于多少。这个操作无疑也改变了X的来源。

所以新的结构因果模型$M_{x}$为
$$
X= x\\
Y= bX+U
$$
再代入 $U = u$ ， $Y_{x}(u) = bx+u$。

在原模型 $M$ 中的反事实 $Y_{x}(u)$ 等于修改过的模型 $M_x$ 中 $Y$ 的计算值:
$$
Y_{x}(u)= Y_{M_{x}}(u)
$$
关于反事实的一致性法则是，如果我们**观测到** $X = x$，那么反事实的结果与原结果保持不变,
$Y_{x} = Y$。

比如我们观测到 $X(u)= 1，Y(w)=0$  ,然后我们求反事实$Y_{x}=1(u)$ , 则 $Y_{x=1}(u)$也等于0。

因为其实没有“反”事实，$X = 1$ 就是事实。所以 $Y$ 也不会变。（是观察，而没有干预等方法，因此是“事实”）

##### 确定性模型的反事实

根据以上的例子，可以总结出计算反事实的方法:

1.**外展(Abduction)** : 使用证据 $E= e$ 来确定 $U$ 的值。(通过大数据统计等)

2.**干预(Action)** : 通过用 $X= x$ 来替换原来模型 $M$ 中变量 $X$ 的表达式,从而修改原模型 $M$ 为 $M_x$ 。加入干预可能需要断边。

3.**预测(Prediction)** :使用修改后的模型 $M_x$ 和第一步计算出的 $U$ 值来计算 $Y$ 值。

一个具体的例子参考博客：https://zhuanlan.zhihu.com/p/120909701

##### 非确定性模型的反事实

1.**外展(Abduction)** : 使用证据 $E= e$ 来确定 $P(U)$ 的值, 得到$P(U|E=e)$ 。(通过大数据统计等)

2.**干预(Action)** : 通过用 $X= x$ 来替换原来模型 $M$ 中变量 $X$ 的表达式,从而修改原模型 $M$ 为 $M_x$ 。加入干预可能需要断边。

3.**预测(Prediction)** :使用修改后的模型 $M_x$ 和第一步计算出的 $P(U|E=e)$ 值来计算 $Y$ 值。

使用中介时不能把中介当做条件（否则会断开联系）。用之前的公式代入即可。

![1.15.png](https://github.com/H-shw/Transformer_etc./blob/master/notes/casual%20inference/pics/1.15.png?raw=true)